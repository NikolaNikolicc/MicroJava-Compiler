<?xml version="1.0" encoding="UTF-8"?>
<project name="MJCompiler" default="compile" basedir=".">
    <target name="delete">
        <delete dir="bin"/>
        <delete dir="src/rs/ac/bg/etf/pp1/lexical_analysis/output/"/>
        <delete dir="src/rs/ac/bg/etf/pp1/syntax_analysis/output/"/>
        <delete dir="src/rs/ac/bg/etf/pp1/code_generation/output"/>

        <mkdir dir="bin"/>
        <mkdir dir="src/rs/ac/bg/etf/pp1/lexical_analysis/output"/>
        <mkdir dir="src/rs/ac/bg/etf/pp1/syntax_analysis/output"/>
        <mkdir dir="src/rs/ac/bg/etf/pp1/code_generation/output"/>
    </target>

    <target name="generateLexer" depends="delete">
        <java jar="lib/JFlex.jar" fork="true" failonerror="true">
            <arg value="-d"/>
            <arg value="src/rs/ac/bg/etf/pp1/lexical_analysis/output"/>
            <arg value="src/rs/ac/bg/etf/pp1/lexical_analysis/mjlexer.flex"/>
        </java>
    </target>

    <target name="generateParser" depends="generateLexer">
        <java jar="lib/cup_v10k.jar" dir="src" fork="true" failonerror="true">
            <arg value="-destdir"/>
            <arg value="rs/ac/bg/etf/pp1/syntax_analysis/output/"/>
            <arg value="-ast"/>
            <arg value="rs.ac.bg.etf.pp1.syntax_analysis.output.ast"/>
            <arg value="-parser"/>
            <arg value="MJParser"/>
            <arg value="-dump_states"/>
            <arg value="-buildtree"/>
            <arg value="rs/ac/bg/etf/pp1/syntax_analysis/mjparser.cup"/>
        </java>
        <move file="src/rs/ac/bg/etf/pp1/syntax_analysis/mjparser_astbuild.cup"
              tofile="src/rs/ac/bg/etf/pp1/syntax_analysis/output/mjparser_astbuild.cup"/>
    </target>

    <target name="compile" depends="generateParser">
        <javac destdir="bin" includeantruntime="false" debug="true" fork="true" failonerror="true">
            <src path="src/rs/ac/bg/etf/pp1"/>
            <classpath>
                <fileset dir="lib" includes="*.jar"/>
            </classpath>
        </javac>
    </target>

    <target name="objDisasm">
        <java classname="rs.etf.pp1.mj.runtime.disasm">
            <arg value="src/rs/ac/bg/etf/pp1/code_generation/output/mjprogram.obj"/>
            <classpath>
                <pathelement location="lib/mj-runtime-1.1.jar"/>
            </classpath>
        </java>
    </target>

    <target name="objDebug" depends="objDisasm">
        <java classname="rs.etf.pp1.mj.runtime.Run" input="src/rs/ac/bg/etf/pp1/code_generation/input/input.txt">
            <arg value="src/rs/ac/bg/etf/pp1/code_generation/output/mjprogram.obj"/>
            <arg value="-debug"/>
            <classpath>
                <pathelement location="lib/mj-runtime-1.1.jar"/>
            </classpath>
        </java>
    </target>

    <target name="objRun" depends="objDebug">
        <java classname="rs.etf.pp1.mj.runtime.Run" input="src/rs/ac/bg/etf/pp1/code_generation/input/input.txt">
            <arg value="src/rs/ac/bg/etf/pp1/code_generation/output/mjprogram.obj"/>
            <classpath>
                <pathelement location="lib/mj-runtime-1.1.jar"/>
            </classpath>
        </java>
    </target>

    <target name="generateJar" depends="compile">
        <jar destfile="bin/mjcompiler.jar" basedir="bin">
            <zipgroupfileset dir="lib" includes="*.jar"/>
            <manifest>
                <attribute name="Main-Class" value="rs.ac.bg.etf.pp1.autorun.CompilerAutorun"/>
            </manifest>
        </jar>
    </target>
</project>